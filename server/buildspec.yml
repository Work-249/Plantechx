version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 22
    commands:
      - echo "Installing dependencies..."
      - cd server
      - npm install

  build:
    commands:
      - echo "Building application..."
      - cd server || true
      - npm run build 2>/dev/null || echo "No build script, skipping..."
      - echo "Creating deployment package..."
      - zip -r deployment.zip . -x "node_modules/mocha/*" "node_modules/supertest/*" "node_modules/nodemon/*" ".git/*" ".env*"
      - echo "Uploading to S3..."
      - TIMESTAMP=$(date +%s)
      - aws s3 cp deployment.zip s3://plantechx-backend-bucket/my-backend-api-$TIMESTAMP.zip --region ap-south-1
      - echo "Deploying Lambda function..."
      - TIMESTAMP=$(date +%s)
      - S3_KEY="my-backend-api-$TIMESTAMP.zip"
      - aws lambda update-function-code --function-name my-backend-api --s3-bucket plantechx-backend-bucket --s3-key $S3_KEY --region ap-south-1 2>/dev/null || aws lambda create-function --function-name my-backend-api --runtime nodejs22.x --role arn:aws:iam::141113059735:role/lambda-execution-role --handler index.handler --s3-bucket plantechx-backend-bucket --s3-key $S3_KEY --region ap-south-1
      - echo "Build and deployment complete!"

artifacts:
  files:
    - server/deployment.zip
  name: backend-artifacts
